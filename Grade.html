<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grade Calculator for Teachers</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* กำหนด font-family และพื้นหลัง */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        /* สำหรับการจัดตารางให้ดูดีบนมือถือ */
        .table-container {
            overflow-x: auto;
        }

        th, td {
            white-space: nowrap;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <!-- ส่วนหลักของแอปพลิเคชัน -->
    <div class="bg-white rounded-xl shadow-2xl p-6 md:p-10 w-full max-w-5xl">

        <!-- หัวข้อแอป -->
        <h1 class="text-3xl md:text-4xl font-extrabold text-center text-gray-800 mb-2">ระบบคำนวณเกรด</h1>
        <p class="text-center text-gray-500 mb-8">เครื่องมือสำหรับครูเพื่อคำนวณเกรดนักเรียน</p>

        <!-- ฟอร์มกำหนดน้ำหนักคะแนน -->
        <div class="bg-blue-50 rounded-lg p-6 mb-8 shadow-inner">
            <h2 class="text-xl font-bold text-gray-700 mb-4">กำหนดน้ำหนักคะแนน</h2>
            <div class="flex flex-col md:flex-row gap-4 items-center">
                <div class="w-full">
                    <label for="workWeightInput" class="block text-sm font-medium text-gray-700">คะแนนเก็บ (0.0-1.0)</label>
                    <input type="number" id="workWeightInput" value="0.6" step="0.1" min="0" max="1"
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2.5">
                </div>
                <div class="w-full">
                    <label for="examWeightInput" class="block text-sm font-medium text-gray-700">คะแนนสอบ (0.0-1.0)</label>
                    <input type="number" id="examWeightInput" value="0.4" step="0.1" min="0" max="1"
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2.5">
                </div>
            </div>
            <p id="weightSumWarning" class="text-red-500 text-sm mt-2 hidden">คำเตือน: ผลรวมน้ำหนักคะแนนควรเป็น 1.0</p>
        </div>

        <!-- ฟอร์มเพิ่มรายชื่อนักเรียน -->
        <div class="bg-green-50 rounded-lg p-6 mb-8 shadow-inner">
            <h2 class="text-xl font-bold text-gray-700 mb-4">เพิ่มข้อมูลนักเรียน</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <input type="text" id="studentNameInput" placeholder="ชื่อนักเรียน"
                       class="rounded-md border-gray-300 shadow-sm p-2.5 md:col-span-2 focus:border-green-500 focus:ring-green-500">
                <input type="number" id="workScoreInput" placeholder="คะแนนเก็บ (0-100)" min="0" max="100"
                       class="rounded-md border-gray-300 shadow-sm p-2.5 focus:border-green-500 focus:ring-green-500">
                <input type="number" id="examScoreInput" placeholder="คะแนนสอบ (0-100)" min="0" max="100"
                       class="rounded-md border-gray-300 shadow-sm p-2.5 focus:border-green-500 focus:ring-green-500">
            </div>
            <button id="addStudentBtn"
                    class="mt-6 w-full rounded-md border border-transparent bg-green-600 py-3 px-6 text-base font-medium text-white shadow-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition duration-150 ease-in-out">
                เพิ่มนักเรียน
            </button>
        </div>

        <!-- ตารางแสดงผลลัพธ์ -->
        <div class="bg-gray-50 rounded-lg p-4 shadow-inner table-container">
            <h2 class="text-xl font-bold text-gray-700 mb-4">ตารางคะแนนและเกรด</h2>
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-200">
                    <tr>
                        <th scope="col" class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            #
                        </th>
                        <th scope="col" class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            ชื่อ
                        </th>
                        <th scope="col" class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            คะแนนเก็บ
                        </th>
                        <th scope="col" class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            คะแนนสอบ
                        </th>
                        <th scope="col" class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            คะแนนรวม
                        </th>
                        <th scope="col" class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            เกรด
                        </th>
                        <th scope="col" class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            จัดการ
                        </th>
                    </tr>
                </thead>
                <tbody id="studentTableBody" class="bg-white divide-y divide-gray-200">
                    <!-- ข้อมูลนักเรียนจะถูกเพิ่มที่นี่ด้วย JavaScript -->
                </tbody>
            </table>
        </div>

        <!-- ปุ่มสำหรับคำนวณ, ล้างข้อมูล และ Export -->
        <div class="flex flex-col md:flex-row gap-4 mt-8">
            <button id="calculateAllBtn"
                    class="w-full rounded-md border border-transparent bg-blue-600 py-3 px-6 text-base font-medium text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-150 ease-in-out">
                คำนวณเกรดทั้งหมดใหม่
            </button>
            <button id="clearAllBtn"
                    class="w-full rounded-md border border-gray-300 bg-white py-3 px-6 text-base font-medium text-gray-700 shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition duration-150 ease-in-out">
                ล้างข้อมูลนักเรียนทั้งหมด
            </button>
            <button id="exportCsvBtn"
                    class="w-full rounded-md border border-transparent bg-gray-700 py-3 px-6 text-base font-medium text-white shadow-sm hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-gray-600 focus:ring-offset-2 transition duration-150 ease-in-out">
                EXPORT CSV
            </button>
        </div>
    </div>

    <!-- JavaScript สำหรับการทำงานของระบบ -->
    <script>
        // เริ่มต้นการทำงานของ JavaScript
        document.addEventListener('DOMContentLoaded', () => {

            // --- 1. การกำหนดตัวแปรและอ้างอิงถึง DOM Element ---
            const workWeightInput = document.getElementById('workWeightInput');
            const examWeightInput = document.getElementById('examWeightInput');
            const studentNameInput = document.getElementById('studentNameInput');
            const workScoreInput = document.getElementById('workScoreInput');
            const examScoreInput = document.getElementById('examScoreInput');
            const addStudentBtn = document.getElementById('addStudentBtn');
            const studentTableBody = document.getElementById('studentTableBody');
            const calculateAllBtn = document.getElementById('calculateAllBtn');
            const clearAllBtn = document.getElementById('clearAllBtn');
            const exportCsvBtn = document.getElementById('exportCsvBtn');
            const weightSumWarning = document.getElementById('weightSumWarning');

            let students = []; // อาร์เรย์สำหรับเก็บข้อมูลนักเรียน
            const localStorageKey = 'studentsData'; // คีย์สำหรับ localStorage

            // --- 2. ฟังก์ชันหลักในการคำนวณและจัดการข้อมูล ---

            /**
             * ฟังก์ชันสำหรับคำนวณเกรดจากคะแนนรวม
             * @param {number} totalScore - คะแนนรวม
             * @returns {string} เกรดที่ได้ (A, B, C, D, F)
             */
            function calculateGrade(totalScore) {
                if (totalScore >= 80) return 'A';
                if (totalScore >= 70) return 'B';
                if (totalScore >= 60) return 'C';
                if (totalScore >= 50) return 'D';
                return 'F';
            }

            /**
             * ฟังก์ชันสำหรับคำนวณคะแนนรวมจากคะแนนเก็บและคะแนนสอบ
             * @param {number} workScore - คะแนนเก็บ
             * @param {number} examScore - คะแนนสอบ
             * @param {number} workWeight - น้ำหนักคะแนนเก็บ
             * @param {number} examWeight - น้ำหนักคะแนนสอบ
             * @returns {number} คะแนนรวมที่คำนวณได้
             */
            function calculateTotalScore(workScore, examScore, workWeight, examWeight) {
                return (workScore * workWeight) + (examScore * examWeight);
            }

            /**
             * ฟังก์ชันสำหรับบันทึกข้อมูลนักเรียนลงใน localStorage
             */
            function saveStudents() {
                localStorage.setItem(localStorageKey, JSON.stringify(students));
            }

            /**
             * ฟังก์ชันสำหรับแสดงข้อมูลนักเรียนในตาราง
             */
            function renderStudents() {
                studentTableBody.innerHTML = ''; // ล้างตารางเก่า
                const workWeight = parseFloat(workWeightInput.value) || 0;
                const examWeight = parseFloat(examWeightInput.value) || 0;
                const weightSum = (workWeight + examWeight).toFixed(1);
                
                // แสดงคำเตือนถ้าผลรวมน้ำหนักไม่เท่ากับ 1.0
                if (weightSum !== '1.0') {
                    weightSumWarning.classList.remove('hidden');
                } else {
                    weightSumWarning.classList.add('hidden');
                }

                students.forEach((student, index) => {
                    // คำนวณคะแนนรวมและเกรดสำหรับนักเรียนแต่ละคน
                    const totalScore = calculateTotalScore(student.workScore, student.examScore, workWeight, examWeight);
                    const roundedTotalScore = totalScore.toFixed(2);
                    const grade = calculateGrade(totalScore);

                    // สร้างแถว (row) ใหม่ในตาราง
                    const row = document.createElement('tr');
                    row.classList.add('hover:bg-gray-50');

                    // สร้างเซลล์ (cell) สำหรับแต่ละคอลัมน์
                    row.innerHTML = `
                        <td class="py-3 px-4 text-sm font-medium text-gray-900">${index + 1}</td>
                        <td class="py-3 px-4 text-sm text-gray-500">${student.name}</td>
                        <td class="py-3 px-4 text-sm text-gray-500">${student.workScore}</td>
                        <td class="py-3 px-4 text-sm text-gray-500">${student.examScore}</td>
                        <td class="py-3 px-4 text-sm text-gray-900 font-semibold">${roundedTotalScore}</td>
                        <td class="py-3 px-4 text-sm font-bold ${grade === 'A' ? 'text-green-600' : grade === 'B' ? 'text-blue-600' : grade === 'C' ? 'text-yellow-600' : grade === 'D' ? 'text-orange-600' : 'text-red-600'}">${grade}</td>
                        <td class="py-3 px-4 text-sm">
                            <button class="delete-btn text-red-500 hover:text-red-700 transition duration-150 ease-in-out" data-index="${index}">
                                ลบ
                            </button>
                        </td>
                    `;
                    studentTableBody.appendChild(row);
                });
            }

            // --- 3. การจัดการ Event Listener ---

            // Event listener สำหรับปุ่ม "เพิ่มนักเรียน"
            addStudentBtn.addEventListener('click', (e) => {
                e.preventDefault();
                const name = studentNameInput.value.trim();
                const workScore = parseFloat(workScoreInput.value);
                const examScore = parseFloat(examScoreInput.value);

                // ตรวจสอบความถูกต้องของข้อมูล
                if (!name || isNaN(workScore) || isNaN(examScore) || workScore < 0 || workScore > 100 || examScore < 0 || examScore > 100) {
                    alert('กรุณากรอกข้อมูลให้ครบถ้วนและถูกต้อง (คะแนน 0-100)');
                    return;
                }

                const newStudent = { name, workScore, examScore };
                students.push(newStudent);
                saveStudents(); // บันทึกข้อมูล
                renderStudents(); // แสดงผลใหม่
                
                // ล้างฟอร์ม
                studentNameInput.value = '';
                workScoreInput.value = '';
                examScoreInput.value = '';
                studentNameInput.focus();
            });

            // Event listener สำหรับปุ่ม "ลบ" แต่ละแถว
            studentTableBody.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-btn')) {
                    const index = parseInt(e.target.dataset.index, 10);
                    students.splice(index, 1); // ลบนักเรียนออกจากอาร์เรย์
                    saveStudents(); // บันทึกข้อมูล
                    renderStudents(); // แสดงผลใหม่
                }
            });

            // Event listener สำหรับปุ่ม "คำนวณเกรดทั้งหมดใหม่"
            calculateAllBtn.addEventListener('click', renderStudents);

            // Event listener สำหรับปุ่ม "ล้างข้อมูลนักเรียนทั้งหมด"
            clearAllBtn.addEventListener('click', () => {
                students = [];
                saveStudents(); // ล้างข้อมูลใน localStorage
                renderStudents(); // ล้างตารางในหน้าเว็บ
            });

            // Event listener สำหรับปุ่ม "EXPORT CSV"
            exportCsvBtn.addEventListener('click', () => {
                const workWeight = parseFloat(workWeightInput.value) || 0;
                const examWeight = parseFloat(examWeightInput.value) || 0;

                const csvHeader = ["#", "ชื่อ", "คะแนนเก็บ", "คะแนนสอบ", "คะแนนรวม", "เกรด"];
                
                const csvRows = students.map((student, index) => {
                    const totalScore = calculateTotalScore(student.workScore, student.examScore, workWeight, examWeight).toFixed(2);
                    const grade = calculateGrade(totalScore);
                    return [
                        index + 1,
                        `"${student.name.replace(/"/g, '""')}"`, // ใส่ double quotes และ escape ถ้ามี
                        student.workScore,
                        student.examScore,
                        totalScore,
                        grade
                    ];
                });

                // รวมหัวตารางและแถวข้อมูล
                const csvData = [csvHeader, ...csvRows].map(row => row.join(',')).join('\n');
                
                // สร้าง Blob และ URL สำหรับดาวน์โหลด
                const blob = new Blob(["\ufeff" + csvData], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'grade_report.csv';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });

            // Event listener สำหรับ input น้ำหนักคะแนน เพื่อคำนวณเกรดใหม่แบบอัตโนมัติ
            workWeightInput.addEventListener('input', renderStudents);
            examWeightInput.addEventListener('input', renderStudents);

            // --- 4. การโหลดข้อมูลเริ่มต้น ---

            /**
             * ฟังก์ชันสำหรับโหลดข้อมูลเริ่มต้นเมื่อเปิดหน้าเว็บ
             */
            function initializeApp() {
                const storedStudents = localStorage.getItem(localStorageKey);
                if (storedStudents) {
                    students = JSON.parse(storedStudents);
                } else {
                    // กรณีไม่มีข้อมูลใน localStorage ให้ใช้ข้อมูลตัวอย่าง
                    students = [
                        { name: 'สมาน ใจดี', workScore: 92, examScore: 88 },
                        { name: 'สมศรี มีสุข', workScore: 75, examScore: 85 },
                        { name: 'ชูชัย มุ่งมั่น', workScore: 60, examScore: 72 },
                        { name: 'กานดา อารี', workScore: 55, examScore: 68 },
                        { name: 'วิชัย รักเรียน', workScore: 48, examScore: 55 }
                    ];
                    saveStudents();
                }
                renderStudents(); // แสดงผลข้อมูลเริ่มต้น
            }

            initializeApp(); // เรียกฟังก์ชันเริ่มต้น
        });
    </script>

</body>
</html>
